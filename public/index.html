<html>
<head>
    <script src="js/jxl.js" type="text/javascript"></script>
    <script src="js/func.js" type="text/javascript"></script>
    <script src="js/jsl.js" type="text/javascript"></script>
    <script src="js/html2.js" type="text/javascript"></script>
    <script src="js/ajax.js" type="text/javascript"></script>
    <script src="js/timer.js" type="text/javascript"></script>
    <style type="text/css">
        @font-face {
          font-family: 'Source Sans Pro';
          src: url('/css/rd/fonts/sourcesanspro.woff');
        }
    
        @font-face {
          font-family: 'Source Sans Pro';
          src: url('/css/rd/fonts/sourcesansproBold.woff');
          font-weight: bold;
        }
    
        @font-face {
          font-family: 'AVM';
          src: url('/css/rd/fonts/metaWebProBold.woff');
          font-weight: bold;
        }
    
        html,
        input,
        textarea,
        keygen,
        select,
        button {
          font-family: 'Source Sans Pro', Arial, sans-serif;
        }
    
        .blue_bar_title,
        .logoArea {
          font-family: 'AVM', 'Source Sans Pro', Arial, sans-serif;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="css/rd/main.css" />
    <link rel="stylesheet" type="text/css" href="css/default/timer.css" class="oldpage" />
</head>
<body  class="mainBtn">
    <style>
        div.leftright {
            width: 99%;
            overflow: hidden;
            border: 1px solid #C6C7BE;
        }
    
        div.leftright div.left {
            width: 580px;
            padding: 2px 0 5px 15px;
            float: left;
        }
    
        div.leftright div.right {
            border: 0 solid #C6C7BE;
            border-left-width: 1px;
            padding: 2px 0 5px 15px;
            margin-left: 580px;
        }
    
        @media (max-width: 700px) {
            div.leftright {
                border: 0px solid #C6C7BE;
            }
            div.leftright div.left {
                width: auto;
            }
            div.leftright div.right {
                width: auto;
                margin-left: 0;
                display: none;
            }
        }
        #clients {
            width: 15em;
        }
    </style>
    <div id="content" class="selectable" role="main" aria-live="polite" style="margin: 5px;">
        <div>
            <form id="uiMainform" name="mainform" class="narrow">
                <div class="leftright">
                    <div class="left">
                        <h4>Time Schedule</h4>
                        <p>Here you can define the period during which the assigned network devices are allowed to use the Internet.
                        </p>
                                <div id="uiTimerArea">
                        </div>
                    </div>
                    <div class="right">
                        <h4>Clients</h4>
                        <p>Here you can define the clients that will be blocked based on the time schedule.<br/>
                            Use CTRL/CMD to select multiple clients.
                        </p>
                        <div>
                            <select id="clients" name="clients" multiple size=15>
                            </select>
                        </div>
                        <div style="clear:both;"></div>
                    </div>
                </div>
                <div id="btn_form_foot">
                    <button type="submit" name="apply" id="uiApply">OK</button>
                    <button type="reset" name="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

<script>
    var gTimer;

    /**
     * Extract timer data from server into on/off periods
     * @param  {Object} timerdata - data returned from the server
     * @param  {number} timerdata[].action - 1=enable, 0=disable
     * @param  {number} timerdata[].day -  day this action is for Mon=0...Sun=6
     * @param  {string} timerdata[].time - 24hr time that timer is to occur
     */
    function extractTimerData(res) {
        var timers = Object.values(JSON.parse(res)).sort( (a,b) => {
            return a.day < b.day ? -1 : a.day > b.day ? 1 : a.time < b.time ? -1 : a.time > b.time ? 1 : a.action - b.action 
        })
        var periods = []
        for (var i=0; i < timers.length; i=i+2) {
            var day = timers[i].day
            if (typeof periods[day] === 'undefined') {
                periods[day] = []
            }
            periods[day].push({on: timers[i].time, off: timers[i+1].time})
        }
        for (var i=0; i < 7; i++) {
            if (typeof periods[i] === 'undefined') {
                periods[i] = []
            }
        }
        return periods
    }
    /*
    * Get items that are selected in a list
    * @param  {Object} select - html <select> element containing <option> items
    */
    function getSelectValues(select) {
        var result = [];
        var options = select && select.options;
        var opt;

        for (var i = 0, iLen = options.length; i < iLen; i++) {
            opt = options[i];

            if (opt.selected) {
                result.push(opt.value || opt.text);
            }
        }
        return result;
    }    

    var form = document.getElementById('uiMainform')
    var handleformSubmit = (event) => {
        event.preventDefault()
        var data = gTimer.save()
        ajaxPostJSON('/api/timer', data, (xhr) => {
            if (xhr.status == 200) {
                gTimer = createTimer('uiTimer',extractTimerData(xhr.response))
            }
            var blockedClients = getSelectValues(document.forms[0].elements.namedItem('clients'))
            ajaxPostJSON('/api/blocked-clients',blockedClients)
        })
    }
    form.addEventListener('submit', handleformSubmit)

    var uiTimer = getHtmlTimer('uiTimer', {active: 'Internet use allowed', inactive: 'Internet use blocked'})
    document.getElementById('uiTimerArea').append(uiTimer)

    ajaxGet('/api/timer', (res) => {
        gTimer = createTimer('uiTimer',extractTimerData(res.response))
    })

    ajaxGet('/api/unifi-clients', (res) => {
        var clients = JSON.parse(res.response)
        clients.sort( (a, b) => { 
            var name = (el) => { return typeof (el.name) == 'undefined' ? typeof (el.hostname) == 'undefined' ? el.mac : el.hostname : el.name }
            return name(a) < name(b) ? -1 : name(a) > name(b) ? 1 : 0
        })
        var clientSelect = document.getElementById('clients')
        ajaxGet('/api/blocked-clients', (res) => {
            var blockedClientsSet = new Set(JSON.parse(res.response))
            clients.forEach( (client) => {
                var clientOption = document.createElement('option');
                clientOption.setAttribute('value', client.mac);
                clientOption.innerText = typeof (client.name) == 'undefined' ? typeof (client.hostname) == 'undefined' ? client.mac : client.hostname : client.name
                if (blockedClientsSet.has(client.mac)) {
                    clientOption.selected = true
                }
                clientSelect.appendChild(clientOption);
            })
        })
    })
</script>   
</body>    
</html>